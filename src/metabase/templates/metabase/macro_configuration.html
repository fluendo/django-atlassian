{% extends 'atlassian_addon/page.html' %}
{% block extra-scripts %}
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
{% endblock %}

{% block main %}
<script type="text/underscore-template" id="itemConfigurationTemplate">
  <form class='aui'>
    <div class='field-group'>
      <label for='payload'>Payload:<span class='aui-icon icon-required'>required</span></label>
      <textarea data-aui-validation-field class="textarea" name="payload" id="payload" rows="6" placeholder="The Metabase payload as defined on the embeddable code"><% if(payload) print(JSON.stringify(payload, null, 2)) %></textarea>
    </div>
    <fieldset class="group">
      <legend><span>Theme</span></legend>
      <div class="radio">
        <input class="radio" type="radio" <% if(theme == "night") { %> checked="checked" <% } %> name="theme" id="night">
        <label for="night">Night</label>
      </div>
      <div class="radio">
        <input class="radio" type="radio" <% if(theme == "light") { %> checked="checked" <% } %> name="theme" id="light">
        <label for="light">Light</label>
      </div>
    </fieldset>
    <fieldset class="group">
      <legend><span>Style</span></legend>
      <div class="checkbox">
        <input class="checkbox" type="checkbox" name="border" id="border" <% if(border) { %> checked="checked" <% } %>>
        <label for="border">Show border</label>
      </div>
      <div class="checkbox">
        <input class="checkbox" type="checkbox" name="title" id="title" <% if(title) { %> checked="checked" <% } %>>
        <label for="title">Show title</label>
      </div>
    </fieldset>
  </form>
</script>

<script>
  var ItemConfigurationView = function() {
    return {
      template: function(value) {
        return _.template($('#itemConfigurationTemplate').html())(value);
      },
      render: function(config) {
        var cur_iframe = "{{ iframe_url }}"
        if (config.payload) {
          $('#metabase-macro-configuration').html(this.template(config));
        } else {
          $('#metabase-macro-configuration').html(this.template({
            payload: null,
            border: true,
            title: true,
            theme: 'light',
          }));
        }
      }
    }
  };

  AP.require(["confluence", "dialog"], function (confluence, dialog) {
    dialog.getButton("submit").bind(function() {
      var $payload = JSON.parse($('#payload').val());
      var $theme = $("input[name='theme']:checked").attr('id');
      var $border = $('#border').prop('checked');
      var $title = $('#title').prop('checked');
      var configuration = JSON.stringify({payload: $payload, theme: $theme, border: $border, title: $title});
      AP.confluence.saveMacro({data: configuration});
      return true;
    });
  });

  AP.require("confluence", function (confluence) {
    AP.confluence.getMacroData(function(macroParams) {
      if (macroParams.data)
        configuration = JSON.parse(macroParams.data);
      else
        configuration = {};
      new ItemConfigurationView().render(configuration);
    });
  });
</script>

<div class="aui-page-panel ac-content">
  <div class="aui-page-panel-inner">
    <section class="aui-page-panel-content">
      <div id="metabase-macro-configuration" class="aui-item">
      </div>
    </section>
  </div>
</div>
{% endblock %}

